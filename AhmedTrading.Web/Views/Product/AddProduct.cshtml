@using AhmedTrading.Repository
@model ProductViewModel
@{
    ViewData["Title"] = "Add Product Info";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}
@section styles{
    <style>
        .remove { cursor: pointer }
        .remove:hover { color: #ff0000 }

        #formProduct .select-wrapper input.select-dropdown { margin: 0 0 .5rem; }
    </style>
}

<div class="m-md-3">
    <h4 class="mb-3 page-header">Add Product Info</h4>
    <section class="card px-4 mt-3">
        <form id="formProduct" asp-action="AddProduct">
            <div class="d-flex align-items-center">
                <div class="md-form">
                    <select name="ProductBrandId" id="ProductBrand" asp-items="ViewBag.ProductBrand" class="mdb-select m-0" required>
                        <option value="" selected>Select Brand</option>
                    </select>
                </div>

                <div class="md-form mx-4">
                    <input asp-for="ProductName" class="form-control" required />
                    <label for="ProductName">Product Name</label>
                    <span asp-validation-for="ProductName"></span>
                </div>

                <div>
                    <div class="custom-control custom-radio custom-control-inline">
                        <input type="radio" value="Ton" class="custom-control-input" id="1" name="UnitType">
                        <label class="custom-control-label" for="1">Ton</label>
                    </div>
                    <div class="custom-control custom-radio custom-control-inline">
                        <input type="radio" checked value="Ream" class="custom-control-input" id="2" name="UnitType">
                        <label class="custom-control-label" for="2">Ream</label>
                    </div>
                </div>

                <div class="text-right">
                    <input type="submit" value="Add Product" class="btn blue-bg-btn btn-rounded" />
                </div>
            </div>
        </form>
    </section>

    <section class="card card-body mt-3">
        <h4 id="categoryName"></h4>
        <table class="table">
            <thead>
                <tr>
                    <th><strong>Product Name</strong></th>
                    <th><strong>Selling Unit Price</strong></th>
                    <th><strong>Unit Type</strong></th>
                    <th><strong>Remove</strong></th>
                </tr>
            </thead>
            <tbody id="tbody"></tbody>
        </table>
    </section>
</div>

@section Scripts{
    <script>
        // Material Select Initialization
        $('.mdb-select').materialSelect();

        // selectors
        const ProductBrand = document.getElementById('ProductBrand');
        const tbody = document.getElementById('tbody');

        // functions
        const getProductsInfo = function (brandId = 0) {
            const url = '/Product/GetProductByBrand'
            const param = { params: { brandId } };

            axios.get(url, param).then(res => {
                let html = '';
                res.data.forEach(item => {
                    html += `<tr>
                            <td class="text-left">${item.ProductName}</td>
                            <td>${item.SellingUnitPrice}</td>
                            <td>${item.UnitType}</td>
                            <td class="text-left">${item.Stock}</td>
                            <td style="width:50px; text-align:center"><i class="fa fa-trash-alt remove red-text" id="${item.ProductId}"></i></td>
                            </tr>`
                })

                tbody.innerHTML = ''
                tbody.innerHTML = html
            }).catch(err => console.log(err))
        }

        //on change dropdown
        const onCategoryChanged = function () {
            const brandId = +this.value;
            if (!brandId) return;

            const categoryName = document.getElementById('categoryName')
            categoryName.textContent = this.options[this.selectedIndex].text;

            getProductsInfo(brandId);
        }

        //remove
        const onRemoveClicked = function (e) {
            const clicked = e.target.classList.contains('remove');
            if (!clicked) return;

            const id = e.target.id
            const url = '/Product/DeleteProduct'
            const param = { params: { id } };

            axios.get(url, param).then(res => {
                if (res.data !== -1) {
                    e.target.parentElement.parentElement.remove();
                } else {
                    alert('this product already used!')
                }
            }).catch(err => console.log(err))
        }

        // call function
        getProductsInfo()

        // event
        ProductBrand.addEventListener('change', onCategoryChanged)
        tbody.addEventListener('click', onRemoveClicked)
    </script>
}
